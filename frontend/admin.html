          <div id="login-error" class="login-error" style="display:none;">❌ Falha no login! Verifique suas credenciais.</div>
<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin — Sala de Sinais PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />

  </head>
  <body class="container">
    <div class="admin fade-in">
      <h1>🚀 Admin — Sala de Sinais PRO</h1>
      <div id="auth" class="section-card">
        <div class="grid">
          <div class="full form-group">
            <label>📧 Email</label>
            <input id="email" placeholder="admin@csi.invest" />
          </div>
          <div class="full form-group">
            <label>🔐 Senha</label>
            <input id="password" type="password" placeholder="••••••••" />
          </div>
        </div>
        <div class="cta">
          <button id="btn-login" class="btn btn-primary">
            🚪 Entrar
          </button>
          <div id="login-error" style="display:none;color:#ff4444;font-weight:bold;margin-top:10px;text-align:center;">❌ Falha no login! Verifique suas credenciais.</div>
        </div>
      </div>

      <div id="panel" class="hidden">
        <div class="section-card">
          <h3>📈 Enviar Sinal</h3>
          <div class="grid grid-3">
            <div class="form-group">
              <label>💰 Ativo</label>
              <input id="symbol" placeholder="BTC/USDT" />
            </div>
            <div class="form-group">
              <label>📊 Direção</label>
              <select id="direction" title="Direção do sinal">
                <option value="buy">🟢 Buy (Compra)</option>
                <option value="sell">🔴 Sell (Venda)</option>
              </select>
            </div>
            <div class="form-group">
              <label>⏰ Timeframe</label>
              <input id="tf" placeholder="1H, 4H, 1D..." />
            </div>
            <div class="form-group">
              <label>🎯 Entrada</label>
              <input id="entry" type="number" step="0.00001" placeholder="0.00000" />
            </div>
            <div class="form-group">
              <label>🛑 Stop Loss</label>
              <input id="stop" type="number" step="0.00001" placeholder="0.00000" />
            </div>
            <div class="form-group">
              <label>💎 Take Profits</label>
              <input id="tps" placeholder="67800, 69500, 72000" />
            </div>
            <div class="full form-group">
              <label>📝 Motivo/Análise</label>
              <textarea id="reason" rows="3" placeholder="Padrão de reversão + RSI divergente + Volume crescente..."></textarea>
            </div>
            <div class="full form-group">
              <label>🖼️ Imagem do Gráfico (URL)</label>
              <input id="imageUrl" placeholder="https://tradingview.com/chart/..." />
            </div>
          </div>
          <div class="cta">
            <button id="btn-send-signal" class="btn btn-primary">
              📤 Enviar Sinal ao Telegram
            </button>
          </div>
        </div>

        <div class="section-card">
          <h3>🤖 Bot Telegram - Configuração e Gerenciamento</h3>
          
          <div class="grid grid-2" style="margin-bottom: 20px;">
            <div class="form-group">
              <label>🤖 Status do Bot</label>
              <input id="bot-status" readonly style="background: rgba(0,0,0,0.3);" value="Verificando..." />
            </div>
            <div class="form-group">
              <label>🔗 Webhook Status</label>
              <input id="webhook-status" readonly style="background: rgba(0,0,0,0.3);" value="Não configurado" />
            </div>
          </div>

          <div class="form-group">
            <label>🌐 URL do Webhook</label>
            <input id="webhook-url" placeholder="https://seu-dominio.com/api/telegram/telegram" />
          </div>

          <div class="cta" style="margin-bottom: 24px;">
            <button id="btn-bot-info" class="btn btn-secondary">🔍 Verificar Bot</button>
            <button id="btn-setup-webhook" class="btn btn-primary">🔗 Configurar Webhook</button>
            <button id="btn-remove-webhook" class="btn btn-danger">🗑️ Remover Webhook</button>
          </div>
        </div>

        <div class="section-card">
          <h3>📱 Telegram - Estatísticas e Testes</h3>
          <div id="telegram-stats" class="grid grid-3" style="margin-bottom: 20px;">
            <div class="form-group">
              <label>👥 Usuários Totais</label>
              <input id="stats-total" readonly style="background: rgba(0,0,0,0.3);" />
            </div>
            <div class="form-group">
              <label>📱 Com Telegram</label>
              <input id="stats-telegram" readonly style="background: rgba(0,0,0,0.3);" />
            </div>
            <div class="form-group">
              <label>✅ Ativos + Telegram</label>
              <input id="stats-active" readonly style="background: rgba(0,0,0,0.3);" />
            </div>
          </div>
          
          <div class="grid grid-2">
            <div class="form-group">
              <label>💬 Mensagem de Teste</label>
              <textarea id="test-message" rows="3" placeholder="Digite uma mensagem para testar o envio...">🧪 <b>TESTE DE SISTEMA</b>

📱 Este é um teste do sistema de notificações do Telegram.

✅ Se você recebeu esta mensagem, o sistema está funcionando corretamente!

🕒 ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}</textarea>
            </div>
            <div class="form-group">
              <label>🎯 Tipo de Envio</label>
              <select id="test-type">
                <option value="channel">📢 Apenas Canal Principal</option>
                <option value="broadcast">📡 Broadcast (Canal + Usuários)</option>
                <option value="private">👤 Privado (Digite Telegram ID abaixo)</option>
              </select>
              <input id="test-telegram-id" placeholder="Telegram ID para envio privado" style="margin-top: 8px; display: none;" />
            </div>
          </div>
          
          <div class="cta">
            <button id="btn-refresh-stats" class="btn btn-secondary">🔄 Atualizar Estatísticas</button>
            <button id="btn-test-telegram" class="btn btn-outline">📤 Testar Envio</button>
            <button id="btn-test-bot" class="btn btn-success">🤖 Testar Bot</button>
          </div>
        </div>

        <div class="section-card">
          <h3>�👥 Gerenciar Usuários</h3>
          <div class="row mb-0">
            <input id="new_email" placeholder="📧 email@cliente.com" />
            <input id="new_name" placeholder="👤 Nome Completo" />
            <input id="new_telegram" placeholder="📱 Telegram ID (opcional)" />
            <select id="new_plan" title="Plano do usuário">
              <option value="basic">🥉 Básico</option>
              <option value="pro">🥈 Pro</option>
              <option value="vip">🥇 VIP</option>
            </select>
            <select id="new_status" title="Status inicial do usuário">
              <option value="active">✅ Ativo</option>
              <option value="expired">⏰ Expirado</option>
              <option value="canceled">❌ Cancelado</option>
            </select>
            <input id="new_valid" type="date" placeholder="Validade" />
            <button id="btn-create-user" class="btn btn-success">
              ➕ Criar Usuário
            </button>
          </div>
        </div>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>📧 Email</th>
                <th>� Nome</th>
                <th>� Telegram</th>
                <th>� Plano</th>
                <th>🔄 Status</th>
                <th>📅 Validade</th>
                <th>⚙️ Ações</th>
              </tr>
            </thead>
            <tbody id="users"></tbody>
          </table>
        </div>

        <!-- Seção de Tutoriais -->
        <div class="section-card">
          <h3>📚 Central de Conteúdo Educativo</h3>
          
          <div class="tutorial-stats">
            <div class="stat-card">
              <div class="stat-icon">👥</div>
              <div class="stat-info">
                <div class="stat-number" id="studentsCount">0</div>
                <div class="stat-label">Usuários Ativos</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">📖</div>
              <div class="stat-info">
                <div class="stat-number">5</div>
                <div class="stat-label">Guias Disponíveis</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">⏰</div>
              <div class="stat-info">
                <div class="stat-number">2h</div>
                <div class="stat-label">Tempo Total</div>
              </div>
            </div>
          </div>

          <div class="tutorial-actions">
            <div class="tutorial-section">
              <h4>🎯 Ações Rápidas</h4>
              <div class="tutorial-buttons">
                <a href="./educativo.html" target="_blank" class="btn btn-primary">
                  📖 Visualizar Guia Completo
                </a>
                <button id="btn-notify-users" class="btn btn-accent">
                  📢 Notificar Novos Conteúdos
                </button>
                <button id="btn-analytics" class="btn btn-ghost">
                  📊 Ver Estatísticas de Acesso
                </button>
              </div>
            </div>

            <div class="tutorial-section">
              <h4>📈 Conteúdos Educativos</h4>
              <div class="content-grid">
                <div class="content-item">
                  <div class="content-icon">🏦</div>
                  <div class="content-info">
                    <h5>Como Abrir Conta na Binance</h5>
                    <p>Guia completo passo-a-passo</p>
                    <span class="content-status active">✅ Ativo</span>
                  </div>
                </div>
                
                <div class="content-item">
                  <div class="content-icon">📊</div>
                  <div class="content-info">
                    <h5>Fundamentos do Trading</h5>
                    <p>Conceitos básicos e terminologia</p>
                    <span class="content-status active">✅ Ativo</span>
                  </div>
                </div>
                
                <div class="content-item">
                  <div class="content-icon">🛡️</div>
                  <div class="content-info">
                    <h5>Gerenciamento de Risco</h5>
                    <p>Estratégias de proteção do capital</p>
                    <span class="content-status active">✅ Ativo</span>
                  </div>
                </div>
                
                <div class="content-item">
                  <div class="content-icon">🎯</div>
                  <div class="content-info">
                    <h5>Estratégias de Trading</h5>
                    <p>Técnicas profissionais</p>
                    <span class="content-status active">✅ Ativo</span>
                  </div>
                </div>
                
                <div class="content-item">
                  <div class="content-icon">🔧</div>
                  <div class="content-info">
                    <h5>Ferramentas e Análises</h5>
                    <p>Recursos para traders</p>
                    <span class="content-status active">✅ Ativo</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="tutorial-section">
              <h4>📬 Notificação via Telegram</h4>
              <div class="notification-form">
                <textarea id="notificationMessage" placeholder="Digite a mensagem sobre novos conteúdos educativos..." rows="3"></textarea>
                <div class="notification-options">
                  <label>
                    <input type="checkbox" id="notifyAllUsers" checked>
                    📢 Enviar para todos os usuários ativos
                  </label>
                  <label>
                    <input type="checkbox" id="includeLink">
                    🔗 Incluir link para guia completo
                  </label>
                </div>
                <button id="btn-send-notification" class="btn btn-success">
                  🚀 Enviar Notificação
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      let token = null
      async function login(){
        console.log('🔐 Login function called')
        const email = document.getElementById('email').value
        const password = document.getElementById('password').value
        console.log('📧 Email:', email, '🔑 Password:', password ? '***' : 'empty')
        const r = await fetch('/api/admin/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email, password }) })
        console.log('📡 Response status:', r.status)
        const data = await r.json()
        console.log('📦 Response data:', data)
        if(data.token){
          token = data.token
          document.getElementById('auth').classList.add('hidden')
          document.getElementById('panel').classList.remove('hidden')
          document.getElementById('panel').classList.add('fade-in')
          document.getElementById('login-error').style.display = 'none'
          loadUsers()
        }else{
          document.getElementById('login-error').style.display = 'block'
        }
      }
      async function loadUsers(){
        const r = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer '+token } })
        const data = await r.json()
        const tbody = document.getElementById('users'); tbody.innerHTML=''
        ;(data||[]).forEach(u=>{
          const tr = document.createElement('tr')
          const valid = u.validUntil ? new Date(u.validUntil).toISOString().slice(0,10) : ''
          const planIcon = u.plan === 'vip' ? '🥇' : u.plan === 'pro' ? '🥈' : '🥉'
          const statusIcon = u.status === 'active' ? '✅' : u.status === 'expired' ? '⏰' : '❌'
          tr.innerHTML = `
            <td><input data-id="${u._id}" data-field="email" value="${u.email||''}" title="Email do usuário" /></td>
            <td>
              <select data-id="${u._id}" data-field="plan" title="Plano do usuário">
                <option value="basic" ${u.plan==='basic'?'selected':''}>🥉 Básico</option>
                <option value="pro" ${u.plan==='pro'?'selected':''}>🥈 Pro</option>
                <option value="vip" ${u.plan==='vip'?'selected':''}>🥇 VIP</option>
              </select>
            </td>
            <td>
              <select data-id="${u._id}" data-field="status" title="Status do usuário">
                <option value="active" ${u.status==='active'?'selected':''}>✅ Ativo</option>
                <option value="expired" ${u.status==='expired'?'selected':''}>⏰ Expirado</option>
                <option value="canceled" ${u.status==='canceled'?'selected':''}>❌ Cancelado</option>
              </select>
            </td>
            <td><input data-id="${u._id}" data-field="validUntil" type="date" value="${valid}" title="Data de validade" /></td>
            <td><input disabled value="${u.preapprovalId||''}" class="muted" title="ID da assinatura no Mercado Pago" /></td>
            <td class="actions">
              <button class="btn btn-success" data-action="save" data-id="${u._id}" title="Salvar alterações">💾 Salvar</button>
              <button class="btn btn-danger" data-action="delete" data-id="${u._id}" title="Excluir usuário">🗑️ Excluir</button>
              <button class="btn btn-secondary" data-action="mp-subscribe" data-email="${u.email}" data-plan="${u.plan}" title="Criar assinatura MP">💳 MP Assinar</button>
              <button class="btn btn-secondary" data-action="mp-cancel" data-id="${u._id}" title="Cancelar assinatura MP">⏹️ Cancelar MP</button>
            </td>`
          tbody.appendChild(tr)
        })
      }
      // Event delegation for dynamic user table actions
      document.getElementById('users').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-action]')
        if(!btn) return
        const action = btn.dataset.action
        const id = btn.dataset.id
        if(action==='save') return saveUser(id)
        if(action==='delete') return delUser(id)
        if(action==='mp-subscribe') return mpSubscribe(btn.dataset.email, btn.dataset.plan)
        if(action==='mp-cancel') return mpCancel(id)
      })
      async function sendSignal(){
        const body = {
          symbol: document.getElementById('symbol').value,
          direction: document.getElementById('direction').value,
          timeframe: document.getElementById('tf').value,
          entry: Number(document.getElementById('entry').value),
          stop: Number(document.getElementById('stop').value),
          tps: document.getElementById('tps').value.split(',').map(s=>Number(s.trim())).filter(Boolean),
          reason: document.getElementById('reason').value,
          imageUrl: document.getElementById('imageUrl').value
        }
        const r = await fetch('/api/signals', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify(body) })
        const data = await r.json()
        if(data.ok) alert('🚀 Sinal enviado com sucesso ao Telegram!'); else alert('❌ Falha ao enviar sinal. Tente novamente.')
      }
      async function createUser(){
        const body = {
          email: document.getElementById('new_email').value,
          name: document.getElementById('new_name').value,
          telegramId: document.getElementById('new_telegram').value || null,
          plan: document.getElementById('new_plan').value,
          status: document.getElementById('new_status').value,
          validUntil: document.getElementById('new_valid').value ? new Date(document.getElementById('new_valid').value) : null
        }
        const r = await fetch('/api/admin/users', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify(body) })
        if(r.ok){ 
          loadUsers()
          // Limpar campos após criar
          document.getElementById('new_email').value = ''
          document.getElementById('new_name').value = ''
          document.getElementById('new_telegram').value = ''
          document.getElementById('new_valid').value = ''
          alert('✅ Usuário criado com sucesso!')
        } else alert('❌ Falha ao criar usuário. Verifique os dados.')
      }
      async function saveUser(id){
        const inputs = document.querySelectorAll(`[data-id="${id}"]`)
        const patch = {}; inputs.forEach(el=>{ let v = el.value; if(el.dataset.field==='validUntil'&&v) v=new Date(v); patch[el.dataset.field]=v })
        const r = await fetch('/api/admin/users/'+id, { method:'PATCH', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify(patch) })
        if(r.ok) alert('Salvo ✅'); else alert('Falha ao salvar')
      }
      async function delUser(id){
        if(!confirm('Excluir usuário?')) return
        const r = await fetch('/api/admin/users/'+id, { method:'DELETE', headers:{ 'Authorization':'Bearer '+token } })
        if(r.ok) loadUsers(); else alert('Falha ao excluir')
      }
      async function mpSubscribe(email, plan){
        const r = await fetch('/api/mp/checkout/subscribe', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify({ email, plan }) })
        const d = await r.json()
        if(d.ok) alert('Assinatura MP criada ✅'); else alert('Falha MP: '+(d.error||''))
      }

      // Funções do Bot Telegram
      async function loadBotInfo() {
        try {
          const r = await fetch('/api/telegram/info', { 
            headers: { 'Authorization': 'Bearer ' + token } 
          })
          const info = await r.json()
          
          if (info.ok && info.result) {
            document.getElementById('bot-status').value = `✅ ${info.result.first_name} (@${info.result.username})`
            console.log('🤖 Bot info carregada:', info.result)
          } else {
            document.getElementById('bot-status').value = '❌ Bot não configurado ou inválido'
            console.error('❌ Erro ao carregar bot info:', info)
          }
        } catch (error) {
          document.getElementById('bot-status').value = '❌ Erro na conexão'
          console.error('❌ Erro ao carregar bot info:', error)
        }
      }

      async function setupWebhook() {
        const webhookUrl = document.getElementById('webhook-url').value
        
        if (!webhookUrl.trim()) {
          alert('🌐 Digite a URL do webhook!')
          return
        }
        
        const btnSetup = document.getElementById('btn-setup-webhook')
        btnSetup.disabled = true
        btnSetup.textContent = '🔗 Configurando...'
        
        try {
          const r = await fetch('/api/telegram/setup', { 
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify({ webhookUrl })
          })
          
          const result = await r.json()
          
          if (result.ok) {
            alert('✅ Webhook configurado com sucesso!')
            document.getElementById('webhook-status').value = '✅ Configurado'
            console.log('🔗 Webhook configurado:', result)
          } else {
            alert('❌ Falha ao configurar webhook: ' + (result.error || 'Erro desconhecido'))
            console.error('❌ Erro no webhook:', result)
          }
        } catch (error) {
          alert('❌ Erro ao configurar webhook: ' + error.message)
          console.error('❌ Erro no webhook:', error)
        } finally {
          btnSetup.disabled = false
          btnSetup.textContent = '🔗 Configurar Webhook'
        }
      }

      async function removeWebhook() {
        if (!confirm('🗑️ Tem certeza que deseja remover o webhook?')) return
        
        const btnRemove = document.getElementById('btn-remove-webhook')
        btnRemove.disabled = true
        btnRemove.textContent = '🗑️ Removendo...'
        
        try {
          const r = await fetch('/api/telegram/webhook', { 
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          })
          
          const result = await r.json()
          
          if (result.ok) {
            alert('✅ Webhook removido com sucesso!')
            document.getElementById('webhook-status').value = '❌ Não configurado'
            console.log('🗑️ Webhook removido:', result)
          } else {
            alert('❌ Falha ao remover webhook: ' + (result.error || 'Erro desconhecido'))
            console.error('❌ Erro ao remover webhook:', result)
          }
        } catch (error) {
          alert('❌ Erro ao remover webhook: ' + error.message)
          console.error('❌ Erro ao remover webhook:', error)
        } finally {
          btnRemove.disabled = false
          btnRemove.textContent = '🗑️ Remover Webhook'
        }
      }

      async function testBot() {
        const message = document.getElementById('test-message').value
        const telegramId = prompt('🤖 Digite seu Telegram ID para testar o bot:', '')
        
        if (!telegramId) {
          alert('📱 Telegram ID é necessário para testar o bot!')
          return
        }
        
        if (!message.trim()) {
          alert('📝 Digite uma mensagem para testar!')
          return
        }
        
        const btnTest = document.getElementById('btn-test-bot')
        btnTest.disabled = true
        btnTest.textContent = '🤖 Testando...'
        
        try {
          const r = await fetch('/api/telegram/test', { 
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify({ 
              chatId: telegramId,
              message: message 
            })
          })
          
          const result = await r.json()
          
          if (result.ok && result.sent) {
            alert('✅ Mensagem enviada via bot com sucesso!')
            console.log('🤖 Teste do bot realizado:', result)
          } else {
            alert('❌ Falha no teste do bot. Verifique o Telegram ID e configurações.')
            console.error('❌ Erro no teste do bot:', result)
          }
        } catch (error) {
          alert('❌ Erro ao testar bot: ' + error.message)
          console.error('❌ Erro no teste do bot:', error)
        } finally {
          btnTest.disabled = false
          btnTest.textContent = '🤖 Testar Bot'
        }
      }

      // Funções do Telegram
      async function loadTelegramStats() {
        try {
          const r = await fetch('/api/admin/telegram-stats', { 
            headers: { 'Authorization': 'Bearer ' + token } 
          })
          const stats = await r.json()
          
          document.getElementById('stats-total').value = `${stats.total_users} usuários`
          document.getElementById('stats-telegram').value = `${stats.users_with_telegram} (${stats.coverage_percentage}%)`
          document.getElementById('stats-active').value = `${stats.active_users_with_telegram} usuários`
          
          console.log('📊 Estatísticas do Telegram carregadas:', stats)
        } catch (error) {
          console.error('❌ Erro ao carregar estatísticas:', error)
        }
      }

      async function testTelegram() {
        const message = document.getElementById('test-message').value
        const type = document.getElementById('test-type').value
        const telegramId = document.getElementById('test-telegram-id').value
        
        if (!message.trim()) {
          alert('📝 Digite uma mensagem para testar!')
          return
        }
        
        if (type === 'private' && !telegramId.trim()) {
          alert('📱 Digite o Telegram ID para envio privado!')
          return
        }
        
        const btnTest = document.getElementById('btn-test-telegram')
        btnTest.disabled = true
        btnTest.textContent = '📤 Enviando...'
        
        try {
          const body = { message, type }
          if (type === 'private') {
            body.telegramId = telegramId
          }
          
          const r = await fetch('/api/admin/test-telegram', { 
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify(body)
          })
          
          const result = await r.json()
          
          if (result.ok && result.sent) {
            alert('✅ Mensagem enviada com sucesso!')
            console.log('📤 Resultado do teste:', result)
          } else {
            alert('❌ Falha ao enviar mensagem. Verifique as configurações do bot.')
            console.error('❌ Erro no teste:', result)
          }
        } catch (error) {
          alert('❌ Erro ao testar Telegram: ' + error.message)
          console.error('❌ Erro no teste:', error)
        } finally {
          btnTest.disabled = false
          btnTest.textContent = '📤 Testar Envio'
        }
      }

      // Atualizar a função loadUsers para incluir Telegram
      const originalLoadUsers = loadUsers
      loadUsers = async function() {
        const r = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + token } })
        const users = await r.json()
        const tbody = document.getElementById('users')
        tbody.innerHTML = users.map(u => {
          const validUntil = u.validUntil ? new Date(u.validUntil).toISOString().slice(0,10) : ''
          const telegramDisplay = u.telegramId ? 
            `<span style="color: #48bb78;">✅ ${u.telegramId}</span>` : 
            `<span style="color: #f56565;">❌ Não configurado</span>`
          
          return `<tr>
            <td><input data-id="${u._id}" data-field="email" value="${u.email||''}" disabled style="background:rgba(0,0,0,0.3)" /></td>
            <td><input data-id="${u._id}" data-field="name" value="${u.name||''}" /></td>
            <td><input data-id="${u._id}" data-field="telegramId" value="${u.telegramId||''}" placeholder="Telegram ID" /></td>
            <td><select data-id="${u._id}" data-field="plan">
              <option value="basic" ${u.plan==='basic'?'selected':''}>🥉 Básico</option>
              <option value="pro" ${u.plan==='pro'?'selected':''}>🥈 Pro</option>
              <option value="vip" ${u.plan==='vip'?'selected':''}>🥇 VIP</option>
            </select></td>
            <td><select data-id="${u._id}" data-field="status">
              <option value="active" ${u.status==='active'?'selected':''}>✅ Ativo</option>
              <option value="expired" ${u.status==='expired'?'selected':''}>⏰ Expirado</option>
              <option value="canceled" ${u.status==='canceled'?'selected':''}>❌ Cancelado</option>
            </select></td>
            <td><input data-id="${u._id}" data-field="validUntil" type="date" value="${validUntil}" /></td>
            <td class="actions">
              <button class="btn btn-success" onclick="saveUser('${u._id}')">💾</button>
              <button class="btn btn-danger" onclick="delUser('${u._id}')">🗑️</button>
            </td>
          </tr>`
        }).join('')
      }
      async function mpCancel(userId){
        const r = await fetch('/api/mp/checkout/subscribe/cancel/'+userId, {
          method:'POST',
          headers:{ 'Authorization':'Bearer '+token }
        })
        const d = await r.json()
        if(d.ok){ alert('Assinatura pausada/cancelada ✅'); loadUsers() } else { alert('Falha ao cancelar: '+(d.error||'')) }
      }

      // Attach event listeners to static buttons (avoid inline onclick due to CSP)
      document.addEventListener('DOMContentLoaded', () => {
        console.log('🔧 DOM loaded, attaching event listeners...')
        const btnLogin = document.getElementById('btn-login')
        if(btnLogin) {
          console.log('✅ Login button found, attaching listener')
          btnLogin.addEventListener('click', login)
        } else {
          console.error('❌ Login button NOT found!')
        }
        
        const btnSendSignal = document.getElementById('btn-send-signal')
        if(btnSendSignal) {
          btnSendSignal.addEventListener('click', sendSignal)
        }
        
        const btnCreateUser = document.getElementById('btn-create-user')
        if(btnCreateUser) {
          btnCreateUser.addEventListener('click', createUser)
        }

        // Event listeners para Bot Telegram
        const btnBotInfo = document.getElementById('btn-bot-info')
        if(btnBotInfo) {
          btnBotInfo.addEventListener('click', loadBotInfo)
        }

        const btnSetupWebhook = document.getElementById('btn-setup-webhook')
        if(btnSetupWebhook) {
          btnSetupWebhook.addEventListener('click', setupWebhook)
        }

        const btnRemoveWebhook = document.getElementById('btn-remove-webhook')
        if(btnRemoveWebhook) {
          btnRemoveWebhook.addEventListener('click', removeWebhook)
        }

        // Event listeners para Telegram
        const btnRefreshStats = document.getElementById('btn-refresh-stats')
        if(btnRefreshStats) {
          btnRefreshStats.addEventListener('click', loadTelegramStats)
        }

        const btnTestTelegram = document.getElementById('btn-test-telegram')
        if(btnTestTelegram) {
          btnTestTelegram.addEventListener('click', testTelegram)
        }

        const btnTestBot = document.getElementById('btn-test-bot')
        if(btnTestBot) {
          btnTestBot.addEventListener('click', testBot)
        }

        const testTypeSelect = document.getElementById('test-type')
        const testTelegramIdInput = document.getElementById('test-telegram-id')
        if(testTypeSelect && testTelegramIdInput) {
          testTypeSelect.addEventListener('change', function() {
            if(this.value === 'private') {
              testTelegramIdInput.style.display = 'block'
            } else {
              testTelegramIdInput.style.display = 'none'
            }
          })
        }

        // Funcionalidades da seção de tutoriais
        const btnNotifyUsers = document.getElementById('btn-notify-users')
        const btnAnalytics = document.getElementById('btn-analytics')
        const btnSendNotification = document.getElementById('btn-send-notification')
        const studentsCountElement = document.getElementById('studentsCount')

        // Atualizar contador de usuários ativos
        function updateStudentsCount() {
          const activeUsers = document.querySelectorAll('#users tr').length
          if (studentsCountElement) {
            studentsCountElement.textContent = activeUsers
          }
        }

        // Notificar usuários sobre novos conteúdos
        if (btnNotifyUsers) {
          btnNotifyUsers.addEventListener('click', function() {
            const message = "📚 Novos conteúdos educativos disponíveis!\n\n🎯 Guias atualizados sobre:\n• Como abrir conta na Binance\n• Fundamentos do Trading\n• Gerenciamento de Risco\n• Estratégias Profissionais\n\n🔗 Acesse: " + window.location.origin + "/educativo.html\n\n💎 CSI Invest - Sua educação em primeiro lugar!"
            document.getElementById('notificationMessage').value = message
            document.getElementById('includeLink').checked = true
          })
        }

        // Visualizar analytics
        if (btnAnalytics) {
          btnAnalytics.addEventListener('click', function() {
            alert('📊 Analytics em desenvolvimento!\n\nEm breve você poderá ver:\n• Páginas mais acessadas\n• Tempo de permanência\n• Conclusão de tutoriais\n• Feedback dos usuários')
          })
        }

        // Enviar notificação via Telegram
        if (btnSendNotification) {
          btnSendNotification.addEventListener('click', async function() {
            const message = document.getElementById('notificationMessage').value
            const notifyAll = document.getElementById('notifyAllUsers').checked
            const includeLink = document.getElementById('includeLink').checked

            if (!message.trim()) {
              alert('⚠️ Digite uma mensagem para enviar!')
              return
            }

            btnSendNotification.disabled = true
            btnSendNotification.textContent = '📤 Enviando...'

            try {
              let finalMessage = message
              if (includeLink && !message.includes('educativo.html')) {
                finalMessage += '\n\n🔗 Guia Completo: ' + window.location.origin + '/educativo.html'
              }

              // Se notificar todos, enviar para o canal principal
              const response = await fetch('/api/telegram/send-message', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  message: finalMessage,
                  type: notifyAll ? 'channel' : 'private'
                })
              })

              const result = await response.json()
              
              if (result.ok) {
                alert('✅ Notificação enviada com sucesso!')
                document.getElementById('notificationMessage').value = ''
              } else {
                alert('❌ Erro ao enviar notificação: ' + (result.error || 'Verifique as configurações'))
              }
            } catch (error) {
              alert('❌ Erro ao enviar notificação: ' + error.message)
              console.error('Erro:', error)
            } finally {
              btnSendNotification.disabled = false
              btnSendNotification.textContent = '🚀 Enviar Notificação'
            }
          })
        }

        // Modificar a função loadUsers original para atualizar o contador
        const originalLoadUsersFunction = loadUsers
        loadUsers = async function() {
          await originalLoadUsersFunction()
          updateStudentsCount()
        }

        // Carregar dados iniciais
        loadUsers()
        loadTelegramStats()
        loadBotInfo()
        
        console.log('🔧 Event listeners attached')
      })
    </script>
  </body>
</html>
