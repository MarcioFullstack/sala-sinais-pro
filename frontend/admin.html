          <div id="login-error" class="login-error" style="display:none;">âŒ Falha no login! Verifique suas credenciais.</div>
<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin â€” Sala de Sinais PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />

  </head>
  <body class="container">
    <div class="admin fade-in">
      <h1>ğŸš€ Admin â€” Sala de Sinais PRO</h1>
      <div id="auth" class="section-card">
        <div class="grid">
          <div class="full form-group">
            <label>ğŸ“§ Email</label>
            <input id="email" placeholder="admin@csi.invest" />
          </div>
          <div class="full form-group">
            <label>ğŸ” Senha</label>
            <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
        </div>
        <div class="cta">
          <button id="btn-login" class="btn btn-primary">
            ğŸšª Entrar
          </button>
          <div id="login-error" style="display:none;color:#ff4444;font-weight:bold;margin-top:10px;text-align:center;">âŒ Falha no login! Verifique suas credenciais.</div>
        </div>
      </div>

      <div id="panel" class="hidden">
        <div class="section-card">
          <h3>ğŸ“ˆ Enviar Sinal</h3>
          <div class="grid grid-3">
            <div class="form-group">
              <label>ğŸ’° Ativo</label>
              <input id="symbol" placeholder="BTC/USDT" />
            </div>
            <div class="form-group">
              <label>ğŸ“Š DireÃ§Ã£o</label>
              <select id="direction" title="DireÃ§Ã£o do sinal">
                <option value="buy">ğŸŸ¢ Buy (Compra)</option>
                <option value="sell">ğŸ”´ Sell (Venda)</option>
              </select>
            </div>
            <div class="form-group">
              <label>â° Timeframe</label>
              <input id="tf" placeholder="1H, 4H, 1D..." />
            </div>
            <div class="form-group">
              <label>ğŸ¯ Entrada</label>
              <input id="entry" type="number" step="0.00001" placeholder="0.00000" />
            </div>
            <div class="form-group">
              <label>ğŸ›‘ Stop Loss</label>
              <input id="stop" type="number" step="0.00001" placeholder="0.00000" />
            </div>
            <div class="form-group">
              <label>ğŸ’ Take Profits</label>
              <input id="tps" placeholder="67800, 69500, 72000" />
            </div>
            <div class="full form-group">
              <label>ğŸ“ Motivo/AnÃ¡lise</label>
              <textarea id="reason" rows="3" placeholder="PadrÃ£o de reversÃ£o + RSI divergente + Volume crescente..."></textarea>
            </div>
            <div class="full form-group">
              <label>ğŸ–¼ï¸ Imagem do GrÃ¡fico (URL)</label>
              <input id="imageUrl" placeholder="https://tradingview.com/chart/..." />
            </div>
          </div>
          <div class="cta">
            <button id="btn-send-signal" class="btn btn-primary">
              ğŸ“¤ Enviar Sinal ao Telegram
            </button>
          </div>
        </div>

        <div class="section-card">
          <h3>ğŸ¤– Bot Telegram - ConfiguraÃ§Ã£o e Gerenciamento</h3>
          
          <div class="grid grid-2" style="margin-bottom: 20px;">
            <div class="form-group">
              <label>ğŸ¤– Status do Bot</label>
              <input id="bot-status" readonly style="background: rgba(0,0,0,0.3);" value="Verificando..." />
            </div>
            <div class="form-group">
              <label>ğŸ”— Webhook Status</label>
              <input id="webhook-status" readonly style="background: rgba(0,0,0,0.3);" value="NÃ£o configurado" />
            </div>
          </div>

          <div class="form-group">
            <label>ğŸŒ URL do Webhook</label>
            <input id="webhook-url" placeholder="https://seu-dominio.com/api/telegram/telegram" />
          </div>

          <div class="cta" style="margin-bottom: 24px;">
            <button id="btn-bot-info" class="btn btn-secondary">ğŸ” Verificar Bot</button>
            <button id="btn-setup-webhook" class="btn btn-primary">ğŸ”— Configurar Webhook</button>
            <button id="btn-remove-webhook" class="btn btn-danger">ğŸ—‘ï¸ Remover Webhook</button>
          </div>
        </div>

        <div class="section-card">
          <h3>ğŸ“± Telegram - EstatÃ­sticas e Testes</h3>
          <div id="telegram-stats" class="grid grid-3" style="margin-bottom: 20px;">
            <div class="form-group">
              <label>ğŸ‘¥ UsuÃ¡rios Totais</label>
              <input id="stats-total" readonly style="background: rgba(0,0,0,0.3);" />
            </div>
            <div class="form-group">
              <label>ğŸ“± Com Telegram</label>
              <input id="stats-telegram" readonly style="background: rgba(0,0,0,0.3);" />
            </div>
            <div class="form-group">
              <label>âœ… Ativos + Telegram</label>
              <input id="stats-active" readonly style="background: rgba(0,0,0,0.3);" />
            </div>
          </div>
          
          <div class="grid grid-2">
            <div class="form-group">
              <label>ğŸ’¬ Mensagem de Teste</label>
              <textarea id="test-message" rows="3" placeholder="Digite uma mensagem para testar o envio...">ğŸ§ª <b>TESTE DE SISTEMA</b>

ğŸ“± Este Ã© um teste do sistema de notificaÃ§Ãµes do Telegram.

âœ… Se vocÃª recebeu esta mensagem, o sistema estÃ¡ funcionando corretamente!

ğŸ•’ ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}</textarea>
            </div>
            <div class="form-group">
              <label>ğŸ¯ Tipo de Envio</label>
              <select id="test-type">
                <option value="channel">ğŸ“¢ Apenas Canal Principal</option>
                <option value="broadcast">ğŸ“¡ Broadcast (Canal + UsuÃ¡rios)</option>
                <option value="private">ğŸ‘¤ Privado (Digite Telegram ID abaixo)</option>
              </select>
              <input id="test-telegram-id" placeholder="Telegram ID para envio privado" style="margin-top: 8px; display: none;" />
            </div>
          </div>
          
          <div class="cta">
            <button id="btn-refresh-stats" class="btn btn-secondary">ğŸ”„ Atualizar EstatÃ­sticas</button>
            <button id="btn-test-telegram" class="btn btn-outline">ğŸ“¤ Testar Envio</button>
            <button id="btn-test-bot" class="btn btn-success">ğŸ¤– Testar Bot</button>
          </div>
        </div>

        <div class="section-card">
          <h3>ï¿½ğŸ‘¥ Gerenciar UsuÃ¡rios</h3>
          <div class="row mb-0">
            <input id="new_email" placeholder="ğŸ“§ email@cliente.com" />
            <input id="new_name" placeholder="ğŸ‘¤ Nome Completo" />
            <input id="new_telegram" placeholder="ğŸ“± Telegram ID (opcional)" />
            <select id="new_plan" title="Plano do usuÃ¡rio">
              <option value="basic">ğŸ¥‰ BÃ¡sico</option>
              <option value="pro">ğŸ¥ˆ Pro</option>
              <option value="vip">ğŸ¥‡ VIP</option>
            </select>
            <select id="new_status" title="Status inicial do usuÃ¡rio">
              <option value="active">âœ… Ativo</option>
              <option value="expired">â° Expirado</option>
              <option value="canceled">âŒ Cancelado</option>
            </select>
            <input id="new_valid" type="date" placeholder="Validade" />
            <button id="btn-create-user" class="btn btn-success">
              â• Criar UsuÃ¡rio
            </button>
          </div>
        </div>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ğŸ“§ Email</th>
                <th>ï¿½ Nome</th>
                <th>ï¿½ Telegram</th>
                <th>ï¿½ Plano</th>
                <th>ğŸ”„ Status</th>
                <th>ğŸ“… Validade</th>
                <th>âš™ï¸ AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody id="users"></tbody>
          </table>
        </div>

        <!-- SeÃ§Ã£o de Tutoriais -->
        <div class="section-card">
          <h3>ğŸ“š Central de ConteÃºdo Educativo</h3>
          
          <div class="tutorial-stats">
            <div class="stat-card">
              <div class="stat-icon">ğŸ‘¥</div>
              <div class="stat-info">
                <div class="stat-number" id="studentsCount">0</div>
                <div class="stat-label">UsuÃ¡rios Ativos</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">ğŸ“–</div>
              <div class="stat-info">
                <div class="stat-number">5</div>
                <div class="stat-label">Guias DisponÃ­veis</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">â°</div>
              <div class="stat-info">
                <div class="stat-number">2h</div>
                <div class="stat-label">Tempo Total</div>
              </div>
            </div>
          </div>

          <div class="tutorial-actions">
            <div class="tutorial-section">
              <h4>ğŸ¯ AÃ§Ãµes RÃ¡pidas</h4>
              <div class="tutorial-buttons">
                <a href="./educativo.html" target="_blank" class="btn btn-primary">
                  ğŸ“– Visualizar Guia Completo
                </a>
                <button id="btn-notify-users" class="btn btn-accent">
                  ğŸ“¢ Notificar Novos ConteÃºdos
                </button>
                <button id="btn-analytics" class="btn btn-ghost">
                  ğŸ“Š Ver EstatÃ­sticas de Acesso
                </button>
              </div>
            </div>

            <div class="tutorial-section">
              <h4>ğŸ“ˆ ConteÃºdos Educativos</h4>
              <div class="content-grid">
                <div class="content-item">
                  <div class="content-icon">ğŸ¦</div>
                  <div class="content-info">
                    <h5>Como Abrir Conta na Binance</h5>
                    <p>Guia completo passo-a-passo</p>
                    <span class="content-status active">âœ… Ativo</span>
                  </div>
                </div>
                
                <div class="content-item">
                  <div class="content-icon">ğŸ“Š</div>
                  <div class="content-info">
                    <h5>Fundamentos do Trading</h5>
                    <p>Conceitos bÃ¡sicos e terminologia</p>
                    <span class="content-status active">âœ… Ativo</span>
                  </div>
                </div>
                
                <div class="content-item">
                  <div class="content-icon">ğŸ›¡ï¸</div>
                  <div class="content-info">
                    <h5>Gerenciamento de Risco</h5>
                    <p>EstratÃ©gias de proteÃ§Ã£o do capital</p>
                    <span class="content-status active">âœ… Ativo</span>
                  </div>
                </div>
                
                <div class="content-item">
                  <div class="content-icon">ğŸ¯</div>
                  <div class="content-info">
                    <h5>EstratÃ©gias de Trading</h5>
                    <p>TÃ©cnicas profissionais</p>
                    <span class="content-status active">âœ… Ativo</span>
                  </div>
                </div>
                
                <div class="content-item">
                  <div class="content-icon">ğŸ”§</div>
                  <div class="content-info">
                    <h5>Ferramentas e AnÃ¡lises</h5>
                    <p>Recursos para traders</p>
                    <span class="content-status active">âœ… Ativo</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="tutorial-section">
              <h4>ğŸ“¬ NotificaÃ§Ã£o via Telegram</h4>
              <div class="notification-form">
                <textarea id="notificationMessage" placeholder="Digite a mensagem sobre novos conteÃºdos educativos..." rows="3"></textarea>
                <div class="notification-options">
                  <label>
                    <input type="checkbox" id="notifyAllUsers" checked>
                    ğŸ“¢ Enviar para todos os usuÃ¡rios ativos
                  </label>
                  <label>
                    <input type="checkbox" id="includeLink">
                    ğŸ”— Incluir link para guia completo
                  </label>
                </div>
                <button id="btn-send-notification" class="btn btn-success">
                  ğŸš€ Enviar NotificaÃ§Ã£o
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      let token = null
      async function login(){
        console.log('ğŸ” Login function called')
        const email = document.getElementById('email').value
        const password = document.getElementById('password').value
        console.log('ğŸ“§ Email:', email, 'ğŸ”‘ Password:', password ? '***' : 'empty')
        const r = await fetch('/api/admin/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email, password }) })
        console.log('ğŸ“¡ Response status:', r.status)
        const data = await r.json()
        console.log('ğŸ“¦ Response data:', data)
        if(data.token){
          token = data.token
          document.getElementById('auth').classList.add('hidden')
          document.getElementById('panel').classList.remove('hidden')
          document.getElementById('panel').classList.add('fade-in')
          document.getElementById('login-error').style.display = 'none'
          loadUsers()
        }else{
          document.getElementById('login-error').style.display = 'block'
        }
      }
      async function loadUsers(){
        const r = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer '+token } })
        const data = await r.json()
        const tbody = document.getElementById('users'); tbody.innerHTML=''
        ;(data||[]).forEach(u=>{
          const tr = document.createElement('tr')
          const valid = u.validUntil ? new Date(u.validUntil).toISOString().slice(0,10) : ''
          const planIcon = u.plan === 'vip' ? 'ğŸ¥‡' : u.plan === 'pro' ? 'ğŸ¥ˆ' : 'ğŸ¥‰'
          const statusIcon = u.status === 'active' ? 'âœ…' : u.status === 'expired' ? 'â°' : 'âŒ'
          tr.innerHTML = `
            <td><input data-id="${u._id}" data-field="email" value="${u.email||''}" title="Email do usuÃ¡rio" /></td>
            <td>
              <select data-id="${u._id}" data-field="plan" title="Plano do usuÃ¡rio">
                <option value="basic" ${u.plan==='basic'?'selected':''}>ğŸ¥‰ BÃ¡sico</option>
                <option value="pro" ${u.plan==='pro'?'selected':''}>ğŸ¥ˆ Pro</option>
                <option value="vip" ${u.plan==='vip'?'selected':''}>ğŸ¥‡ VIP</option>
              </select>
            </td>
            <td>
              <select data-id="${u._id}" data-field="status" title="Status do usuÃ¡rio">
                <option value="active" ${u.status==='active'?'selected':''}>âœ… Ativo</option>
                <option value="expired" ${u.status==='expired'?'selected':''}>â° Expirado</option>
                <option value="canceled" ${u.status==='canceled'?'selected':''}>âŒ Cancelado</option>
              </select>
            </td>
            <td><input data-id="${u._id}" data-field="validUntil" type="date" value="${valid}" title="Data de validade" /></td>
            <td><input disabled value="${u.preapprovalId||''}" class="muted" title="ID da assinatura no Mercado Pago" /></td>
            <td class="actions">
              <button class="btn btn-success" data-action="save" data-id="${u._id}" title="Salvar alteraÃ§Ãµes">ğŸ’¾ Salvar</button>
              <button class="btn btn-danger" data-action="delete" data-id="${u._id}" title="Excluir usuÃ¡rio">ğŸ—‘ï¸ Excluir</button>
              <button class="btn btn-secondary" data-action="mp-subscribe" data-email="${u.email}" data-plan="${u.plan}" title="Criar assinatura MP">ğŸ’³ MP Assinar</button>
              <button class="btn btn-secondary" data-action="mp-cancel" data-id="${u._id}" title="Cancelar assinatura MP">â¹ï¸ Cancelar MP</button>
            </td>`
          tbody.appendChild(tr)
        })
      }
      // Event delegation for dynamic user table actions
      document.getElementById('users').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-action]')
        if(!btn) return
        const action = btn.dataset.action
        const id = btn.dataset.id
        if(action==='save') return saveUser(id)
        if(action==='delete') return delUser(id)
        if(action==='mp-subscribe') return mpSubscribe(btn.dataset.email, btn.dataset.plan)
        if(action==='mp-cancel') return mpCancel(id)
      })
      async function sendSignal(){
        const body = {
          symbol: document.getElementById('symbol').value,
          direction: document.getElementById('direction').value,
          timeframe: document.getElementById('tf').value,
          entry: Number(document.getElementById('entry').value),
          stop: Number(document.getElementById('stop').value),
          tps: document.getElementById('tps').value.split(',').map(s=>Number(s.trim())).filter(Boolean),
          reason: document.getElementById('reason').value,
          imageUrl: document.getElementById('imageUrl').value
        }
        const r = await fetch('/api/signals', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify(body) })
        const data = await r.json()
        if(data.ok) alert('ğŸš€ Sinal enviado com sucesso ao Telegram!'); else alert('âŒ Falha ao enviar sinal. Tente novamente.')
      }
      async function createUser(){
        const body = {
          email: document.getElementById('new_email').value,
          name: document.getElementById('new_name').value,
          telegramId: document.getElementById('new_telegram').value || null,
          plan: document.getElementById('new_plan').value,
          status: document.getElementById('new_status').value,
          validUntil: document.getElementById('new_valid').value ? new Date(document.getElementById('new_valid').value) : null
        }
        const r = await fetch('/api/admin/users', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify(body) })
        if(r.ok){ 
          loadUsers()
          // Limpar campos apÃ³s criar
          document.getElementById('new_email').value = ''
          document.getElementById('new_name').value = ''
          document.getElementById('new_telegram').value = ''
          document.getElementById('new_valid').value = ''
          alert('âœ… UsuÃ¡rio criado com sucesso!')
        } else alert('âŒ Falha ao criar usuÃ¡rio. Verifique os dados.')
      }
      async function saveUser(id){
        const inputs = document.querySelectorAll(`[data-id="${id}"]`)
        const patch = {}; inputs.forEach(el=>{ let v = el.value; if(el.dataset.field==='validUntil'&&v) v=new Date(v); patch[el.dataset.field]=v })
        const r = await fetch('/api/admin/users/'+id, { method:'PATCH', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify(patch) })
        if(r.ok) alert('Salvo âœ…'); else alert('Falha ao salvar')
      }
      async function delUser(id){
        if(!confirm('Excluir usuÃ¡rio?')) return
        const r = await fetch('/api/admin/users/'+id, { method:'DELETE', headers:{ 'Authorization':'Bearer '+token } })
        if(r.ok) loadUsers(); else alert('Falha ao excluir')
      }
      async function mpSubscribe(email, plan){
        const r = await fetch('/api/mp/checkout/subscribe', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify({ email, plan }) })
        const d = await r.json()
        if(d.ok) alert('Assinatura MP criada âœ…'); else alert('Falha MP: '+(d.error||''))
      }

      // FunÃ§Ãµes do Bot Telegram
      async function loadBotInfo() {
        try {
          const r = await fetch('/api/telegram/info', { 
            headers: { 'Authorization': 'Bearer ' + token } 
          })
          const info = await r.json()
          
          if (info.ok && info.result) {
            document.getElementById('bot-status').value = `âœ… ${info.result.first_name} (@${info.result.username})`
            console.log('ğŸ¤– Bot info carregada:', info.result)
          } else {
            document.getElementById('bot-status').value = 'âŒ Bot nÃ£o configurado ou invÃ¡lido'
            console.error('âŒ Erro ao carregar bot info:', info)
          }
        } catch (error) {
          document.getElementById('bot-status').value = 'âŒ Erro na conexÃ£o'
          console.error('âŒ Erro ao carregar bot info:', error)
        }
      }

      async function setupWebhook() {
        const webhookUrl = document.getElementById('webhook-url').value
        
        if (!webhookUrl.trim()) {
          alert('ğŸŒ Digite a URL do webhook!')
          return
        }
        
        const btnSetup = document.getElementById('btn-setup-webhook')
        btnSetup.disabled = true
        btnSetup.textContent = 'ğŸ”— Configurando...'
        
        try {
          const r = await fetch('/api/telegram/setup', { 
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify({ webhookUrl })
          })
          
          const result = await r.json()
          
          if (result.ok) {
            alert('âœ… Webhook configurado com sucesso!')
            document.getElementById('webhook-status').value = 'âœ… Configurado'
            console.log('ğŸ”— Webhook configurado:', result)
          } else {
            alert('âŒ Falha ao configurar webhook: ' + (result.error || 'Erro desconhecido'))
            console.error('âŒ Erro no webhook:', result)
          }
        } catch (error) {
          alert('âŒ Erro ao configurar webhook: ' + error.message)
          console.error('âŒ Erro no webhook:', error)
        } finally {
          btnSetup.disabled = false
          btnSetup.textContent = 'ğŸ”— Configurar Webhook'
        }
      }

      async function removeWebhook() {
        if (!confirm('ğŸ—‘ï¸ Tem certeza que deseja remover o webhook?')) return
        
        const btnRemove = document.getElementById('btn-remove-webhook')
        btnRemove.disabled = true
        btnRemove.textContent = 'ğŸ—‘ï¸ Removendo...'
        
        try {
          const r = await fetch('/api/telegram/webhook', { 
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          })
          
          const result = await r.json()
          
          if (result.ok) {
            alert('âœ… Webhook removido com sucesso!')
            document.getElementById('webhook-status').value = 'âŒ NÃ£o configurado'
            console.log('ğŸ—‘ï¸ Webhook removido:', result)
          } else {
            alert('âŒ Falha ao remover webhook: ' + (result.error || 'Erro desconhecido'))
            console.error('âŒ Erro ao remover webhook:', result)
          }
        } catch (error) {
          alert('âŒ Erro ao remover webhook: ' + error.message)
          console.error('âŒ Erro ao remover webhook:', error)
        } finally {
          btnRemove.disabled = false
          btnRemove.textContent = 'ğŸ—‘ï¸ Remover Webhook'
        }
      }

      async function testBot() {
        const message = document.getElementById('test-message').value
        const telegramId = prompt('ğŸ¤– Digite seu Telegram ID para testar o bot:', '')
        
        if (!telegramId) {
          alert('ğŸ“± Telegram ID Ã© necessÃ¡rio para testar o bot!')
          return
        }
        
        if (!message.trim()) {
          alert('ğŸ“ Digite uma mensagem para testar!')
          return
        }
        
        const btnTest = document.getElementById('btn-test-bot')
        btnTest.disabled = true
        btnTest.textContent = 'ğŸ¤– Testando...'
        
        try {
          const r = await fetch('/api/telegram/test', { 
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify({ 
              chatId: telegramId,
              message: message 
            })
          })
          
          const result = await r.json()
          
          if (result.ok && result.sent) {
            alert('âœ… Mensagem enviada via bot com sucesso!')
            console.log('ğŸ¤– Teste do bot realizado:', result)
          } else {
            alert('âŒ Falha no teste do bot. Verifique o Telegram ID e configuraÃ§Ãµes.')
            console.error('âŒ Erro no teste do bot:', result)
          }
        } catch (error) {
          alert('âŒ Erro ao testar bot: ' + error.message)
          console.error('âŒ Erro no teste do bot:', error)
        } finally {
          btnTest.disabled = false
          btnTest.textContent = 'ğŸ¤– Testar Bot'
        }
      }

      // FunÃ§Ãµes do Telegram
      async function loadTelegramStats() {
        try {
          const r = await fetch('/api/admin/telegram-stats', { 
            headers: { 'Authorization': 'Bearer ' + token } 
          })
          const stats = await r.json()
          
          document.getElementById('stats-total').value = `${stats.total_users} usuÃ¡rios`
          document.getElementById('stats-telegram').value = `${stats.users_with_telegram} (${stats.coverage_percentage}%)`
          document.getElementById('stats-active').value = `${stats.active_users_with_telegram} usuÃ¡rios`
          
          console.log('ğŸ“Š EstatÃ­sticas do Telegram carregadas:', stats)
        } catch (error) {
          console.error('âŒ Erro ao carregar estatÃ­sticas:', error)
        }
      }

      async function testTelegram() {
        const message = document.getElementById('test-message').value
        const type = document.getElementById('test-type').value
        const telegramId = document.getElementById('test-telegram-id').value
        
        if (!message.trim()) {
          alert('ğŸ“ Digite uma mensagem para testar!')
          return
        }
        
        if (type === 'private' && !telegramId.trim()) {
          alert('ğŸ“± Digite o Telegram ID para envio privado!')
          return
        }
        
        const btnTest = document.getElementById('btn-test-telegram')
        btnTest.disabled = true
        btnTest.textContent = 'ğŸ“¤ Enviando...'
        
        try {
          const body = { message, type }
          if (type === 'private') {
            body.telegramId = telegramId
          }
          
          const r = await fetch('/api/admin/test-telegram', { 
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify(body)
          })
          
          const result = await r.json()
          
          if (result.ok && result.sent) {
            alert('âœ… Mensagem enviada com sucesso!')
            console.log('ğŸ“¤ Resultado do teste:', result)
          } else {
            alert('âŒ Falha ao enviar mensagem. Verifique as configuraÃ§Ãµes do bot.')
            console.error('âŒ Erro no teste:', result)
          }
        } catch (error) {
          alert('âŒ Erro ao testar Telegram: ' + error.message)
          console.error('âŒ Erro no teste:', error)
        } finally {
          btnTest.disabled = false
          btnTest.textContent = 'ğŸ“¤ Testar Envio'
        }
      }

      // Atualizar a funÃ§Ã£o loadUsers para incluir Telegram
      const originalLoadUsers = loadUsers
      loadUsers = async function() {
        const r = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + token } })
        const users = await r.json()
        const tbody = document.getElementById('users')
        tbody.innerHTML = users.map(u => {
          const validUntil = u.validUntil ? new Date(u.validUntil).toISOString().slice(0,10) : ''
          const telegramDisplay = u.telegramId ? 
            `<span style="color: #48bb78;">âœ… ${u.telegramId}</span>` : 
            `<span style="color: #f56565;">âŒ NÃ£o configurado</span>`
          
          return `<tr>
            <td><input data-id="${u._id}" data-field="email" value="${u.email||''}" disabled style="background:rgba(0,0,0,0.3)" /></td>
            <td><input data-id="${u._id}" data-field="name" value="${u.name||''}" /></td>
            <td><input data-id="${u._id}" data-field="telegramId" value="${u.telegramId||''}" placeholder="Telegram ID" /></td>
            <td><select data-id="${u._id}" data-field="plan">
              <option value="basic" ${u.plan==='basic'?'selected':''}>ğŸ¥‰ BÃ¡sico</option>
              <option value="pro" ${u.plan==='pro'?'selected':''}>ğŸ¥ˆ Pro</option>
              <option value="vip" ${u.plan==='vip'?'selected':''}>ğŸ¥‡ VIP</option>
            </select></td>
            <td><select data-id="${u._id}" data-field="status">
              <option value="active" ${u.status==='active'?'selected':''}>âœ… Ativo</option>
              <option value="expired" ${u.status==='expired'?'selected':''}>â° Expirado</option>
              <option value="canceled" ${u.status==='canceled'?'selected':''}>âŒ Cancelado</option>
            </select></td>
            <td><input data-id="${u._id}" data-field="validUntil" type="date" value="${validUntil}" /></td>
            <td class="actions">
              <button class="btn btn-success" onclick="saveUser('${u._id}')">ğŸ’¾</button>
              <button class="btn btn-danger" onclick="delUser('${u._id}')">ğŸ—‘ï¸</button>
            </td>
          </tr>`
        }).join('')
      }
      async function mpCancel(userId){
        const r = await fetch('/api/mp/checkout/subscribe/cancel/'+userId, {
          method:'POST',
          headers:{ 'Authorization':'Bearer '+token }
        })
        const d = await r.json()
        if(d.ok){ alert('Assinatura pausada/cancelada âœ…'); loadUsers() } else { alert('Falha ao cancelar: '+(d.error||'')) }
      }

      // Attach event listeners to static buttons (avoid inline onclick due to CSP)
      document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸ”§ DOM loaded, attaching event listeners...')
        const btnLogin = document.getElementById('btn-login')
        if(btnLogin) {
          console.log('âœ… Login button found, attaching listener')
          btnLogin.addEventListener('click', login)
        } else {
          console.error('âŒ Login button NOT found!')
        }
        
        const btnSendSignal = document.getElementById('btn-send-signal')
        if(btnSendSignal) {
          btnSendSignal.addEventListener('click', sendSignal)
        }
        
        const btnCreateUser = document.getElementById('btn-create-user')
        if(btnCreateUser) {
          btnCreateUser.addEventListener('click', createUser)
        }

        // Event listeners para Bot Telegram
        const btnBotInfo = document.getElementById('btn-bot-info')
        if(btnBotInfo) {
          btnBotInfo.addEventListener('click', loadBotInfo)
        }

        const btnSetupWebhook = document.getElementById('btn-setup-webhook')
        if(btnSetupWebhook) {
          btnSetupWebhook.addEventListener('click', setupWebhook)
        }

        const btnRemoveWebhook = document.getElementById('btn-remove-webhook')
        if(btnRemoveWebhook) {
          btnRemoveWebhook.addEventListener('click', removeWebhook)
        }

        // Event listeners para Telegram
        const btnRefreshStats = document.getElementById('btn-refresh-stats')
        if(btnRefreshStats) {
          btnRefreshStats.addEventListener('click', loadTelegramStats)
        }

        const btnTestTelegram = document.getElementById('btn-test-telegram')
        if(btnTestTelegram) {
          btnTestTelegram.addEventListener('click', testTelegram)
        }

        const btnTestBot = document.getElementById('btn-test-bot')
        if(btnTestBot) {
          btnTestBot.addEventListener('click', testBot)
        }

        const testTypeSelect = document.getElementById('test-type')
        const testTelegramIdInput = document.getElementById('test-telegram-id')
        if(testTypeSelect && testTelegramIdInput) {
          testTypeSelect.addEventListener('change', function() {
            if(this.value === 'private') {
              testTelegramIdInput.style.display = 'block'
            } else {
              testTelegramIdInput.style.display = 'none'
            }
          })
        }

        // Funcionalidades da seÃ§Ã£o de tutoriais
        const btnNotifyUsers = document.getElementById('btn-notify-users')
        const btnAnalytics = document.getElementById('btn-analytics')
        const btnSendNotification = document.getElementById('btn-send-notification')
        const studentsCountElement = document.getElementById('studentsCount')

        // Atualizar contador de usuÃ¡rios ativos
        function updateStudentsCount() {
          const activeUsers = document.querySelectorAll('#users tr').length
          if (studentsCountElement) {
            studentsCountElement.textContent = activeUsers
          }
        }

        // Notificar usuÃ¡rios sobre novos conteÃºdos
        if (btnNotifyUsers) {
          btnNotifyUsers.addEventListener('click', function() {
            const message = "ğŸ“š Novos conteÃºdos educativos disponÃ­veis!\n\nğŸ¯ Guias atualizados sobre:\nâ€¢ Como abrir conta na Binance\nâ€¢ Fundamentos do Trading\nâ€¢ Gerenciamento de Risco\nâ€¢ EstratÃ©gias Profissionais\n\nğŸ”— Acesse: " + window.location.origin + "/educativo.html\n\nğŸ’ CSI Invest - Sua educaÃ§Ã£o em primeiro lugar!"
            document.getElementById('notificationMessage').value = message
            document.getElementById('includeLink').checked = true
          })
        }

        // Visualizar analytics
        if (btnAnalytics) {
          btnAnalytics.addEventListener('click', function() {
            alert('ğŸ“Š Analytics em desenvolvimento!\n\nEm breve vocÃª poderÃ¡ ver:\nâ€¢ PÃ¡ginas mais acessadas\nâ€¢ Tempo de permanÃªncia\nâ€¢ ConclusÃ£o de tutoriais\nâ€¢ Feedback dos usuÃ¡rios')
          })
        }

        // Enviar notificaÃ§Ã£o via Telegram
        if (btnSendNotification) {
          btnSendNotification.addEventListener('click', async function() {
            const message = document.getElementById('notificationMessage').value
            const notifyAll = document.getElementById('notifyAllUsers').checked
            const includeLink = document.getElementById('includeLink').checked

            if (!message.trim()) {
              alert('âš ï¸ Digite uma mensagem para enviar!')
              return
            }

            btnSendNotification.disabled = true
            btnSendNotification.textContent = 'ğŸ“¤ Enviando...'

            try {
              let finalMessage = message
              if (includeLink && !message.includes('educativo.html')) {
                finalMessage += '\n\nğŸ”— Guia Completo: ' + window.location.origin + '/educativo.html'
              }

              // Se notificar todos, enviar para o canal principal
              const response = await fetch('/api/telegram/send-message', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  message: finalMessage,
                  type: notifyAll ? 'channel' : 'private'
                })
              })

              const result = await response.json()
              
              if (result.ok) {
                alert('âœ… NotificaÃ§Ã£o enviada com sucesso!')
                document.getElementById('notificationMessage').value = ''
              } else {
                alert('âŒ Erro ao enviar notificaÃ§Ã£o: ' + (result.error || 'Verifique as configuraÃ§Ãµes'))
              }
            } catch (error) {
              alert('âŒ Erro ao enviar notificaÃ§Ã£o: ' + error.message)
              console.error('Erro:', error)
            } finally {
              btnSendNotification.disabled = false
              btnSendNotification.textContent = 'ğŸš€ Enviar NotificaÃ§Ã£o'
            }
          })
        }

        // Modificar a funÃ§Ã£o loadUsers original para atualizar o contador
        const originalLoadUsersFunction = loadUsers
        loadUsers = async function() {
          await originalLoadUsersFunction()
          updateStudentsCount()
        }

        // Carregar dados iniciais
        loadUsers()
        loadTelegramStats()
        loadBotInfo()
        
        console.log('ğŸ”§ Event listeners attached')
      })
    </script>
  </body>
</html>
