<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin â€” Sala de Sinais PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />

  </head>
  <body class="container">
    <div class="admin fade-in">
      <h1>ğŸš€ Admin â€” Sala de Sinais PRO</h1>
      
      <div id="auth" class="section-card">
        <div class="grid">
          <div class="full form-group">
            <label>ğŸ“§ Email</label>
            <input id="email" placeholder="admin@csi.invest" />
          </div>
          <div class="full form-group">
            <label>ğŸ” Senha</label>
            <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
        </div>
        <div class="cta">
          <button id="btn-login" class="btn btn-primary">
            ğŸšª Entrar
          </button>
        </div>
      </div>

      <div id="panel" class="hidden">
        <div class="section-card">
          <h3>ğŸ“ˆ Enviar Sinal</h3>
          <div class="grid grid-3">
            <div class="form-group">
              <label>ğŸ’° Ativo</label>
              <input id="symbol" placeholder="BTC/USDT" />
            </div>
            <div class="form-group">
              <label>ğŸ“Š DireÃ§Ã£o</label>
              <select id="direction" title="DireÃ§Ã£o do sinal">
                <option value="buy">ğŸŸ¢ Buy (Compra)</option>
                <option value="sell">ğŸ”´ Sell (Venda)</option>
              </select>
            </div>
            <div class="form-group">
              <label>â° Timeframe</label>
              <input id="tf" placeholder="1H, 4H, 1D..." />
            </div>
            <div class="form-group">
              <label>ğŸ¯ Entrada</label>
              <input id="entry" type="number" step="0.00001" placeholder="0.00000" />
            </div>
            <div class="form-group">
              <label>ğŸ›‘ Stop Loss</label>
              <input id="stop" type="number" step="0.00001" placeholder="0.00000" />
            </div>
            <div class="form-group">
              <label>ğŸ’ Take Profits</label>
              <input id="tps" placeholder="67800, 69500, 72000" />
            </div>
            <div class="full form-group">
              <label>ğŸ“ Motivo/AnÃ¡lise</label>
              <textarea id="reason" rows="3" placeholder="PadrÃ£o de reversÃ£o + RSI divergente + Volume crescente..."></textarea>
            </div>
            <div class="full form-group">
              <label>ğŸ–¼ï¸ Imagem do GrÃ¡fico (URL)</label>
              <input id="imageUrl" placeholder="https://tradingview.com/chart/..." />
            </div>
          </div>
          <div class="cta">
            <button id="btn-send-signal" class="btn btn-primary">
              ğŸ“¤ Enviar Sinal ao Telegram
            </button>
          </div>
        </div>

        <div class="section-card">
          <h3>ğŸ‘¥ Gerenciar UsuÃ¡rios</h3>
          <div class="row mb-0">
            <input id="new_email" placeholder="ğŸ“§ email@cliente.com" />
            <input id="new_name" placeholder="ğŸ‘¤ Nome Completo" />
            <select id="new_plan" title="Plano do usuÃ¡rio">
              <option value="basic">ğŸ¥‰ BÃ¡sico</option>
              <option value="pro">ğŸ¥ˆ Pro</option>
              <option value="vip">ğŸ¥‡ VIP</option>
            </select>
            <select id="new_status" title="Status inicial do usuÃ¡rio">
              <option value="active">âœ… Ativo</option>
              <option value="expired">â° Expirado</option>
              <option value="canceled">âŒ Cancelado</option>
            </select>
            <input id="new_valid" type="date" placeholder="Validade" />
            <button id="btn-create-user" class="btn btn-success">
              â• Criar UsuÃ¡rio
            </button>
          </div>
        </div>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ğŸ“§ Email</th>
                <th>ğŸ“‹ Plano</th>
                <th>ğŸ”„ Status</th>
                <th>ğŸ“… Validade</th>
                <th>ğŸ·ï¸ MP ID</th>
                <th>âš™ï¸ AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody id="users"></tbody>
          </table>
        </div>
      </div>
    </div>
    <script>
      let token = null
      async function login(){
        console.log('ğŸ” Login function called')
        const email = document.getElementById('email').value
        const password = document.getElementById('password').value
        console.log('ğŸ“§ Email:', email, 'ğŸ”‘ Password:', password ? '***' : 'empty')
        const r = await fetch('/api/admin/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email, password }) })
        console.log('ğŸ“¡ Response status:', r.status)
        const data = await r.json()
        console.log('ğŸ“¦ Response data:', data)
        if(data.token){
          token = data.token
          document.getElementById('auth').classList.add('hidden')
          document.getElementById('panel').classList.remove('hidden')
          document.getElementById('panel').classList.add('fade-in')
          loadUsers()
        }else alert('âŒ Falha no login! Verifique suas credenciais.')
      }
      async function loadUsers(){
        const r = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer '+token } })
        const data = await r.json()
        const tbody = document.getElementById('users'); tbody.innerHTML=''
        ;(data||[]).forEach(u=>{
          const tr = document.createElement('tr')
          const valid = u.validUntil ? new Date(u.validUntil).toISOString().slice(0,10) : ''
          const planIcon = u.plan === 'vip' ? 'ğŸ¥‡' : u.plan === 'pro' ? 'ğŸ¥ˆ' : 'ğŸ¥‰'
          const statusIcon = u.status === 'active' ? 'âœ…' : u.status === 'expired' ? 'â°' : 'âŒ'
          tr.innerHTML = `
            <td><input data-id="${u._id}" data-field="email" value="${u.email||''}" title="Email do usuÃ¡rio" /></td>
            <td>
              <select data-id="${u._id}" data-field="plan" title="Plano do usuÃ¡rio">
                <option value="basic" ${u.plan==='basic'?'selected':''}>ğŸ¥‰ BÃ¡sico</option>
                <option value="pro" ${u.plan==='pro'?'selected':''}>ğŸ¥ˆ Pro</option>
                <option value="vip" ${u.plan==='vip'?'selected':''}>ğŸ¥‡ VIP</option>
              </select>
            </td>
            <td>
              <select data-id="${u._id}" data-field="status" title="Status do usuÃ¡rio">
                <option value="active" ${u.status==='active'?'selected':''}>âœ… Ativo</option>
                <option value="expired" ${u.status==='expired'?'selected':''}>â° Expirado</option>
                <option value="canceled" ${u.status==='canceled'?'selected':''}>âŒ Cancelado</option>
              </select>
            </td>
            <td><input data-id="${u._id}" data-field="validUntil" type="date" value="${valid}" title="Data de validade" /></td>
            <td><input disabled value="${u.preapprovalId||''}" class="muted" title="ID da assinatura no Mercado Pago" /></td>
            <td class="actions">
              <button class="btn btn-success" data-action="save" data-id="${u._id}" title="Salvar alteraÃ§Ãµes">ğŸ’¾ Salvar</button>
              <button class="btn btn-danger" data-action="delete" data-id="${u._id}" title="Excluir usuÃ¡rio">ğŸ—‘ï¸ Excluir</button>
              <button class="btn btn-secondary" data-action="mp-subscribe" data-email="${u.email}" data-plan="${u.plan}" title="Criar assinatura MP">ğŸ’³ MP Assinar</button>
              <button class="btn btn-secondary" data-action="mp-cancel" data-id="${u._id}" title="Cancelar assinatura MP">â¹ï¸ Cancelar MP</button>
            </td>`
          tbody.appendChild(tr)
        })
      }
      // Event delegation for dynamic user table actions
      document.getElementById('users').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-action]')
        if(!btn) return
        const action = btn.dataset.action
        const id = btn.dataset.id
        if(action==='save') return saveUser(id)
        if(action==='delete') return delUser(id)
        if(action==='mp-subscribe') return mpSubscribe(btn.dataset.email, btn.dataset.plan)
        if(action==='mp-cancel') return mpCancel(id)
      })
      async function sendSignal(){
        const body = {
          symbol: document.getElementById('symbol').value,
          direction: document.getElementById('direction').value,
          timeframe: document.getElementById('tf').value,
          entry: Number(document.getElementById('entry').value),
          stop: Number(document.getElementById('stop').value),
          tps: document.getElementById('tps').value.split(',').map(s=>Number(s.trim())).filter(Boolean),
          reason: document.getElementById('reason').value,
          imageUrl: document.getElementById('imageUrl').value
        }
        const r = await fetch('/api/signals', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify(body) })
        const data = await r.json()
        if(data.ok) alert('ğŸš€ Sinal enviado com sucesso ao Telegram!'); else alert('âŒ Falha ao enviar sinal. Tente novamente.')
      }
      async function createUser(){
        const body = {
          email: document.getElementById('new_email').value,
          name: document.getElementById('new_name').value,
          plan: document.getElementById('new_plan').value,
          status: document.getElementById('new_status').value,
          validUntil: document.getElementById('new_valid').value ? new Date(document.getElementById('new_valid').value) : null
        }
        const r = await fetch('/api/admin/users', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify(body) })
        if(r.ok){ 
          loadUsers()
          // Limpar campos apÃ³s criar
          document.getElementById('new_email').value = ''
          document.getElementById('new_name').value = ''
          document.getElementById('new_valid').value = ''
          alert('âœ… UsuÃ¡rio criado com sucesso!')
        } else alert('âŒ Falha ao criar usuÃ¡rio. Verifique os dados.')
      }
      async function saveUser(id){
        const inputs = document.querySelectorAll(`[data-id="${id}"]`)
        const patch = {}; inputs.forEach(el=>{ let v = el.value; if(el.dataset.field==='validUntil'&&v) v=new Date(v); patch[el.dataset.field]=v })
        const r = await fetch('/api/admin/users/'+id, { method:'PATCH', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify(patch) })
        if(r.ok) alert('Salvo âœ…'); else alert('Falha ao salvar')
      }
      async function delUser(id){
        if(!confirm('Excluir usuÃ¡rio?')) return
        const r = await fetch('/api/admin/users/'+id, { method:'DELETE', headers:{ 'Authorization':'Bearer '+token } })
        if(r.ok) loadUsers(); else alert('Falha ao excluir')
      }
      async function mpSubscribe(email, plan){
        const r = await fetch('/api/mp/checkout/subscribe', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify({ email, plan }) })
        const d = await r.json()
        if(d.ok) alert('Assinatura MP criada âœ…'); else alert('Falha MP: '+(d.error||''))
      }
      async function mpCancel(userId){
        const r = await fetch('/api/mp/checkout/subscribe/cancel/'+userId, {
          method:'POST',
          headers:{ 'Authorization':'Bearer '+token }
        })
        const d = await r.json()
        if(d.ok){ alert('Assinatura pausada/cancelada âœ…'); loadUsers() } else { alert('Falha ao cancelar: '+(d.error||'')) }
      }

      // Attach event listeners to static buttons (avoid inline onclick due to CSP)
      document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸ”§ DOM loaded, attaching event listeners...')
        const btnLogin = document.getElementById('btn-login')
        if(btnLogin) {
          console.log('âœ… Login button found, attaching listener')
          btnLogin.addEventListener('click', login)
        } else {
          console.error('âŒ Login button NOT found!')
        }
        
        const btnSendSignal = document.getElementById('btn-send-signal')
        if(btnSendSignal) {
          btnSendSignal.addEventListener('click', sendSignal)
        }
        
        const btnCreateUser = document.getElementById('btn-create-user')
        if(btnCreateUser) {
          btnCreateUser.addEventListener('click', createUser)
        }
        
        console.log('ğŸ”§ Event listeners attached')
      })
    </script>
  </body>
</html>
